{% extends "base.html" %}

{% block title %}Blood Stock Management - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tint me-2"></i>Blood Stock Management</h2>
                <button class="btn btn-primary" onclick="addBloodStock()">
                    <i class="fas fa-plus me-2"></i>Add Blood Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Blood Stock Summary -->
    <div class="row mb-4">
        {% set blood_groups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'] %}
        {% for group in blood_groups %}
        {% set group_stock = blood_stock|selectattr('blood_group', 'equalto', group)|list %}
        {% set total_units = group_stock|sum(attribute='units_available') %}
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="blood-group-badge bg-{{ group.replace('+', 'p').replace('-', 'n') }} mb-3">{{ group }}</div>
                    <h3 class="text-{{ 'success' if total_units > 10 else 'warning' if total_units > 5 else 'danger' }}">{{ total_units }}</h3>
                    <p class="text-muted mb-0">Units Available</p>
                    {% if total_units < 5 %}
                    <small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Low Stock</small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search blood stock...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="bloodGroupFilter">
                <option value="">All Blood Groups</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="available">Available</option>
                <option value="expired">Expired</option>
                <option value="used">Used</option>
            </select>
        </div>
        <div class="col-md-2">
            <a class="btn btn-outline-primary w-100" href="{{ url_for('export_blood_stock_csv') }}">
                <i class="fas fa-download me-1"></i>Export
            </a>
        </div>
    </div>

    <!-- Blood Stock Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Blood Group</th>
                                    <th>Units</th>
                                    <th>Collection Date</th>
                                    <th>Expiry Date</th>
                                    <th>Donor ID</th>
                                    <th>Status</th>
                                    <th>Days to Expiry</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in blood_stock %}
                                {% set days_to_expiry = ((stock.expiry_date.date() if stock.expiry_date else today) - today).days if stock.expiry_date else 0 %}
                                <tr class="{{ 'table-warning' if days_to_expiry < 7 and days_to_expiry > 0 else 'table-danger' if days_to_expiry <= 0 else '' }}">
                                    <td>{{ stock.id }}</td>
                                    <td>
                                        <span class="blood-group-badge bg-{{ stock.blood_group.replace('+', 'p').replace('-', 'n') }}">{{ stock.blood_group }}</span>
                                    </td>
                                    <td>{{ stock.units_available }}</td>
                                    <td>{{ stock.collection_date.strftime('%Y-%m-%d') if stock.collection_date else 'N/A' }}</td>
                                    <td>{{ stock.expiry_date.strftime('%Y-%m-%d') if stock.expiry_date else 'N/A' }}</td>
                                    <td>{{ stock.donor_id or 'N/A' }}</td>
                                    <td>
                                        <span class="status-badge status-{{ stock.status }}">{{ stock.status.title() }}</span>
                                    </td>
                                    <td>
                                        {% if stock.expiry_date %}
                                            {% if days_to_expiry > 0 %}
                                                <span class="text-{{ 'success' if days_to_expiry > 30 else 'warning' if days_to_expiry > 7 else 'danger' }}">
                                                    {{ days_to_expiry }} days
                                                </span>
                                            {% else %}
                                                <span class="text-danger">Expired</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewStock({{ stock.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="editStock({{ stock.id }})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStock({{ stock.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expiry Alerts -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Expiry Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="expiryAlerts">
                        <!-- Expiry alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Blood Stock Modal -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Blood Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <div class="mb-3">
                        <label for="blood_group" class="form-label">Blood Group *</label>
                        <select class="form-select" id="blood_group" name="blood_group" required>
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="units_available" class="form-label">Units Available *</label>
                        <input type="number" class="form-control" id="units_available" name="units_available" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="collection_date" class="form-label">Collection Date *</label>
                        <input type="date" class="form-control" id="collection_date" name="collection_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="expiry_date" class="form-label">Expiry Date *</label>
                        <input type="date" class="form-control" id="expiry_date" name="expiry_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="donor_id" class="form-label">Donor ID</label>
                        <input type="number" class="form-control" id="donor_id" name="donor_id">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStock()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="adminBloodDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Blood Stock Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="adminDetailsBody">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addBloodStock() {
    const form = document.getElementById('stockForm');
    form.reset();
    form.dataset.id = '';
    document.getElementById('stockModal').querySelector('.modal-title').textContent = 'Add Blood Stock';
    new bootstrap.Modal(document.getElementById('stockModal')).show();
}

function viewStock(stockId) {
    const modal = new bootstrap.Modal(document.getElementById('adminBloodDetailsModal'));
    const body = document.getElementById('adminDetailsBody');
    body.innerHTML = '<div class="text-center text-muted">Loading...</div>';
    modal.show();

    fetch(`/blood-stock/${stockId}/details`)
        .then(r => r.json())
        .then(d => {
            const donorHtml = d.donor ? `
                <tr><th>Donor</th><td>${d.donor.name} (ID: ${d.donor.id})</td></tr>
                <tr><th>Donor Group</th><td>${d.donor.blood_group || ''}</td></tr>
            ` : '';
            body.innerHTML = `
                <table class="table table-sm">
                    <tbody>
                        <tr><th>ID</th><td>${d.id}</td></tr>
                        <tr><th>Blood Group</th><td>${d.blood_group}</td></tr>
                        <tr><th>Units</th><td>${d.units_available}</td></tr>
                        <tr><th>Status</th><td>${d.status}</td></tr>
                        <tr><th>Collection Date</th><td>${d.collection_date || 'N/A'}</td></tr>
                        <tr><th>Expiry Date</th><td>${d.expiry_date || 'N/A'}</td></tr>
                        <tr><th>Days to Expiry</th><td>${d.days_to_expiry ?? 'N/A'}</td></tr>
                        ${donorHtml}
                    </tbody>
                </table>
            `;
        })
        .catch(() => {
            body.innerHTML = '<div class="text-danger">Failed to load details.</div>';
        });
}

function editStock(stockId) {
    const form = document.getElementById('stockForm');
    const modalEl = document.getElementById('stockModal');
    const modal = new bootstrap.Modal(modalEl);
    modalEl.querySelector('.modal-title').textContent = 'Edit Blood Stock';

    // Pre-fill with loading state to avoid stale values
    form.reset();
    form.dataset.id = stockId;

    fetch(`/blood-stock/${stockId}/details`)
        .then(r => r.json())
        .then(d => {
            form.dataset.id = d.id;
            if (form.blood_group) form.blood_group.value = d.blood_group || '';
            if (form.units_available) form.units_available.value = d.units_available ?? '';
            if (form.collection_date) form.collection_date.value = d.collection_date || '';
            if (form.expiry_date) form.expiry_date.value = d.expiry_date || '';
            if (form.donor_id) form.donor_id.value = (d.donor && d.donor.id) ? d.donor.id : '';
        })
        .catch(() => {
            // Keep modal open; user can still edit manually
        });

    modal.show();
}

function deleteStock(stockId) {
    if (!confirm('Are you sure you want to delete this blood stock entry?')) {
        return;
    }
    fetch(`/admin/blood-stock/${stockId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(res => {
        if (res.success) {
            window.location.reload();
        } else {
            alert(res.message || 'Failed to delete stock');
        }
    }).catch(() => alert('Failed to delete stock'));
}

function saveStock() {
    const form = document.getElementById('stockForm');
    const payload = {
        id: form.dataset.id || null,
        blood_group: form.blood_group.value,
        units_available: form.units_available.value,
        collection_date: form.collection_date.value,
        expiry_date: form.expiry_date.value,
        donor_id: form.donor_id.value,
        status: 'available'
    };
    fetch('{{ url_for('admin_save_blood_stock') }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(r => r.json()).then(res => {
        if (res.success) {
            window.location.reload();
        } else {
            alert(res.message || 'Failed to save stock');
        }
    }).catch(() => alert('Failed to save stock'));
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr');
    
    tableRows.forEach(function(row) {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

document.getElementById('bloodGroupFilter').addEventListener('change', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);

function filterTable() {
    const bloodGroupFilter = document.getElementById('bloodGroupFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const tableRows = document.querySelectorAll('tbody tr');
    
    tableRows.forEach(function(row) {
        let show = true;
        
        if (bloodGroupFilter) {
            const bloodGroup = row.querySelector('.blood-group-badge')?.textContent;
            if (bloodGroup !== bloodGroupFilter) {
                show = false;
            }
        }
        
        if (statusFilter) {
            const status = row.querySelector('.status-badge')?.textContent.toLowerCase();
            if (status !== statusFilter) {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadExpiryAlerts();
});

function loadExpiryAlerts() {
    const alerts = [
        { bloodGroup: 'A+', units: 2, daysToExpiry: 3 },
        { bloodGroup: 'O-', units: 1, daysToExpiry: 1 }
    ];
    
    const container = document.getElementById('expiryAlerts');
    if (alerts.length > 0) {
        container.innerHTML = alerts.map(alert => `
            <div class="col-md-6 mb-2">
                <div class="alert alert-warning mb-0">
                    <strong>${alert.bloodGroup}:</strong> ${alert.units} units expiring in ${alert.daysToExpiry} days
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<div class="col-12 text-center text-muted">No expiry alerts</div>';
    }
}
</script>
{% endblock %}
