{% extends "base.html" %}

{% block title %}Blood Units Management - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-vial me-2"></i>Blood Units Management</h2>
                <a href="{{ url_for('admin_blood_stock') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add Blood Unit
                </a>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by barcode...">
            </div>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="bloodGroupFilter">
                <option value="">All Blood Groups</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="available">Available</option>
                <option value="used">Used</option>
                <option value="expired">Expired</option>
                <option value="discarded">Discarded</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-primary w-100" onclick="filterTable()">
                <i class="fas fa-filter me-1"></i>Filter
            </button>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-success w-100" onclick="exportUnits()">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>

    <!-- Blood Units Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Blood Group</th>
                                    <th>Units</th>
                                    <th>Collection Date</th>
                                    <th>Expiry Date</th>
                                    <th>Donor</th>
                                    <th>Collection Center</th>
                                    <th>Status</th>
                                    <th>Days to Expiry</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for unit in blood_units %}
                                {% set days_to_expiry = ((unit.expiry_date.date() if unit.expiry_date else today) - today).days if unit.expiry_date else 0 %}
                                <tr class="{{ 'table-warning' if days_to_expiry < 7 and days_to_expiry > 0 else 'table-danger' if days_to_expiry <= 0 else '' }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-barcode me-2"></i>
                                            <code>{{ unit.barcode }}</code>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="blood-group-badge bg-{{ unit.blood_group.replace('+', 'p').replace('-', 'n') }}">{{ unit.blood_group }}</span>
                                    </td>
                                    <td>{{ unit.units }}</td>
                                    <td>{{ unit.collection_date.strftime('%Y-%m-%d') if unit.collection_date else 'N/A' }}</td>
                                    <td>{{ unit.expiry_date.strftime('%Y-%m-%d') if unit.expiry_date else 'N/A' }}</td>
                                    <td>
                                        {% if unit.donor_id %}
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle me-2">
                                                    {{ unit.donor.full_name[0] if unit.donor and unit.donor.full_name else 'D' }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ unit.donor.full_name if unit.donor and unit.donor.full_name else 'Unknown' }}</div>
                                                    <small class="text-muted">ID: {{ unit.donor_id }}</small>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ unit.collection_center or 'N/A' }}</td>
                                    <td>
                                        <span class="status-badge status-{{ unit.status }}">{{ unit.status.title() }}</span>
                                    </td>
                                    <td>
                                        {% if unit.expiry_date %}
                                            {% if days_to_expiry > 0 %}
                                                <span class="text-{{ 'success' if days_to_expiry > 30 else 'warning' if days_to_expiry > 7 else 'danger' }}">
                                                    {{ days_to_expiry }} days
                                                </span>
                                            {% else %}
                                                <span class="text-danger">Expired</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewUnit({{ unit.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="editUnit({{ unit.id }})" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="printBarcode('{{ unit.barcode }}')" title="Print Barcode">
                                                <i class="fas fa-print"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUnit({{ unit.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expiry Alerts -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Expiry Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="expiryAlerts">
                        <!-- Expiry alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function viewUnit(unitId) {
    const modal = new bootstrap.Modal(document.getElementById('unitDetailsModal'));
    const body = document.getElementById('unitDetailsBody');
    body.innerHTML = '<div class="text-center text-muted">Loading...</div>';
    modal.show();

    fetch(`/admin/blood-units/${unitId}/details`)
        .then(r => r.json())
        .then(d => {
            body.innerHTML = `
                <table class="table table-sm">
                    <tbody>
                        <tr><th>ID</th><td>${d.id}</td></tr>
                        <tr><th>Barcode</th><td><code>${d.barcode}</code></td></tr>
                        <tr><th>Blood Group</th><td>${d.blood_group}</td></tr>
                        <tr><th>Units</th><td>${d.units}</td></tr>
                        <tr><th>Status</th><td>${d.status}</td></tr>
                        <tr><th>Collection Date</th><td>${d.collection_date || 'N/A'}</td></tr>
                        <tr><th>Expiry Date</th><td>${d.expiry_date || 'N/A'}</td></tr>
                        <tr><th>Donor</th><td>${d.donor_name ? d.donor_name + ' (ID: ' + (d.donor_id || '') + ')' : 'N/A'}</td></tr>
                        <tr><th>Collection Center</th><td>${d.collection_center || 'N/A'}</td></tr>
                    </tbody>
                </table>
            `;
        })
        .catch(() => {
            body.innerHTML = '<div class="text-danger">Failed to load details.</div>';
        });
}

function editUnit(unitId) {
    const modalEl = document.getElementById('unitEditModal');
    const modal = new bootstrap.Modal(modalEl);
    const form = document.getElementById('unitEditForm');
    form.reset();
    form.dataset.id = unitId;
    modal.show();

    // Prefill form with current values
    fetch(`/admin/blood-units/${unitId}/details`).then(r => r.json()).then(d => {
        form.dataset.id = d.id;
        if (form.blood_group) form.blood_group.value = d.blood_group || '';
        if (form.units) form.units.value = d.units ?? '';
        if (form.collection_date) form.collection_date.value = d.collection_date || '';
        if (form.expiry_date) form.expiry_date.value = d.expiry_date || '';
        if (form.donor_id) form.donor_id.value = d.donor_id || '';
        if (form.status) form.status.value = d.status || 'available';
    }).catch(() => {
        // keep modal open; allow manual input
    });
}

function saveUnitEdit() {
    const form = document.getElementById('unitEditForm');
    const payload = {
        id: form.dataset.id || null,
        blood_group: form.blood_group.value,
        units_available: form.units.value,
        collection_date: form.collection_date.value,
        expiry_date: form.expiry_date.value,
        donor_id: form.donor_id.value,
        status: form.status.value || 'available'
    };
    fetch('/admin/blood-units/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(r => r.json()).then(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('unitEditModal')).hide();
            window.location.reload();
        } else {
            alert(res.message || 'Failed to save unit');
        }
    }).catch(() => alert('Failed to save unit'));
}

function printBarcode(barcode) {
    // This would open a print dialog for the barcode
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Barcode - ${barcode}</title>
                <style>
                    body { text-align: center; font-family: Arial, sans-serif; }
                    .barcode { font-size: 24px; font-weight: bold; margin: 20px; }
                    .label { margin: 10px; }
                </style>
            </head>
            <body>
                <div class="label">Blood Unit Barcode</div>
                <div class="barcode">${barcode}</div>
                <div class="label">BloodConnect</div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function deleteUnit(unitId) {
    if (!confirm('Are you sure you want to delete this blood unit?')) {
        return;
    }
    fetch(`/admin/blood-units/${unitId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()).then(res => {
        if (res.success) {
            window.location.reload();
        } else {
            alert(res.message || 'Failed to delete unit');
        }
    }).catch(() => alert('Failed to delete unit'));
}

function exportUnits() {
    alert('Export feature will be implemented soon!');
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr');
    
    tableRows.forEach(function(row) {
        const barcode = row.querySelector('code')?.textContent.toLowerCase();
        if (barcode && barcode.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Filter functionality
function filterTable() {
    const bloodGroupFilter = document.getElementById('bloodGroupFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const tableRows = document.querySelectorAll('tbody tr');
    
    tableRows.forEach(function(row) {
        let show = true;
        
        if (bloodGroupFilter) {
            const bloodGroup = row.querySelector('.blood-group-badge')?.textContent;
            if (bloodGroup !== bloodGroupFilter) {
                show = false;
            }
        }
        
        if (statusFilter) {
            const status = row.querySelector('.status-badge')?.textContent.toLowerCase();
            if (status !== statusFilter) {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Load expiry alerts
document.addEventListener('DOMContentLoaded', function() {
    loadExpiryAlerts();
});

function loadExpiryAlerts() {
    // This would typically fetch expiry alerts from the server
    const alerts = [
        { barcode: 'BB123456', bloodGroup: 'A+', daysToExpiry: 2 },
        { barcode: 'BB789012', bloodGroup: 'O-', daysToExpiry: 1 }
    ];
    
    const container = document.getElementById('expiryAlerts');
    if (alerts.length > 0) {
        container.innerHTML = alerts.map(alert => `
            <div class="col-md-6 mb-2">
                <div class="alert alert-warning mb-0">
                    <strong>${alert.barcode} (${alert.bloodGroup}):</strong> Expires in ${alert.daysToExpiry} days
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<div class="col-12 text-center text-muted">No expiry alerts</div>';
    }
}
</script>

<!-- Edit Unit Modal -->
<div class="modal fade" id="unitEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Blood Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="unitEditForm">
                    <div class="mb-3">
                        <label class="form-label" for="blood_group">Blood Group *</label>
                        <select class="form-select" id="blood_group" name="blood_group" required>
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="units">Units *</label>
                        <input type="number" class="form-control" id="units" name="units" min="1" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="collection_date">Collection Date *</label>
                        <input type="date" class="form-control" id="collection_date" name="collection_date" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="expiry_date">Expiry Date *</label>
                        <input type="date" class="form-control" id="expiry_date" name="expiry_date" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="donor_id">Donor ID</label>
                        <input type="number" class="form-control" id="donor_id" name="donor_id" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="status">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="available">Available</option>
                            <option value="used">Used</option>
                            <option value="expired">Expired</option>
                            <option value="discarded">Discarded</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUnitEdit()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Unit Details Modal -->
<div class="modal fade" id="unitDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Blood Unit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="unitDetailsBody">
                    <div class="text-center text-muted">Loading...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
}
</style>
{% endblock %}
